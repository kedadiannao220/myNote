<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.20" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>AMQ Topic Subsriber Model &middot; penggy Blog</title>

  
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/print.css" media="print">
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/poole.css">
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/syntax.css">
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="penggy Blog" />
</head>

  <body class=" ">
  <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://kedadiannao220.github.io/"><h1>penggy Blog</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="https://kedadiannao220.github.io/">Home</a> </li>
      <li><a href="/post/"> 首页 </a></li><li><a href="/about/"> 关于 </a></li>
    </ul>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</div>

    <div class="content container">
    <div class="post">
  <h1>AMQ Topic Subsriber Model</h1>
  <span class="post-date">Wed, Dec 27, 2017</span>
  

<h2 id="topic-subsriber模式">Topic Subsriber模式</h2>

<p>订阅模式分为非持久订阅(Non-Durable Topic Subscribers)和持久订阅模式（Durable Topic Subscribers）</p>

<h3 id="非持久订阅-non-durable-topic-subscribers">非持久订阅（Non-Durable Topic Subscribers）</h3>

<ul>
<li>生产者生产消息，谁订阅，谁就会收到</li>
<li>生产者生产消息，没有人订阅，消息废弃，当consumer启动连接时，废弃的消息不会再次被收到</li>
</ul>

<p>代码如下：</p>

<pre><code class="language-java">package com.pgy.jms.sub;

import org.apache.activemq.ActiveMQConnectionFactory;

import javax.jms.*;

/**
 * @Date: Created in 27/12/2017 1:01 PM
 * @Author: pengganyu
 * @Desc:
 */

public class Producer {

    public static void main(String[] args) throws JMSException, InterruptedException {
        ConnectionFactory factory = new ActiveMQConnectionFactory(
            ActiveMQConnectionFactory.DEFAULT_USER, ActiveMQConnectionFactory.DEFAULT_PASSWORD,
            ActiveMQConnectionFactory.DEFAULT_BROKER_URL);

        Connection connection = factory.createConnection();
        connection.start();

        Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);

        Topic topic = session.createTopic(&quot;hello&quot;);

        MessageProducer producer = session.createProducer(topic);

        int i = 0;
        while (true) {
            Thread.sleep(3000);
            producer.send(session.createTextMessage(&quot;hello&quot; + i++));
        }
    }
}

</code></pre>

<pre><code class="language-java">package com.pgy.jms.sub;

import org.apache.activemq.ActiveMQConnectionFactory;

import javax.jms.*;

/**
 * @Date: Created in 27/12/2017 2:19 PM
 * @Author: pengganyu
 * @Desc:
 */

public class Cousmer {

    public static void main(String[] args) throws JMSException {
        TopicConnectionFactory factory = new ActiveMQConnectionFactory(
            ActiveMQConnectionFactory.DEFAULT_USER, ActiveMQConnectionFactory.DEFAULT_PASSWORD,
            ActiveMQConnectionFactory.DEFAULT_BROKER_URL);

        Connection connection = factory.createTopicConnection();
        connection.start();

        Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);

        Topic topic = session.createTopic(&quot;hello&quot;);

        MessageConsumer consumer = session.createConsumer(topic);

        //        consumer.setMessageListener(message -&gt; System.out.println(message));

        while (true) {
            TextMessage textMessage = (TextMessage) consumer.receive();
            System.out.println(textMessage.getText());

        }

    }
}

</code></pre>

<h4 id="说明">说明</h4>

<ul>
<li>生产者在不停地生产消息，如果消费者不启动，消费者是无法接收到消息的；（运行Producer）</li>
<li>消费者启动连接后，之前的消息是不会被接收到，启动后才可以接收到当前生产出来的消息（运行Consumer）</li>
<li>消费者断开连接后，无法接收到生产者生产的消息（停止consumer）</li>
<li>消费者再次连接后，之前丢失的消息无法继续再收到，只能接收到当前生产出来的消息（启动consumer）</li>
</ul>

<h3 id="持久订阅-durable-topic-subscribers">持久订阅（Durable Topic Subscribers）</h3>

<p>生产者的代码与非持久的相同，consumer的代码如下</p>

<pre><code class="language-java">package com.pgy.jms.sub;

import org.apache.activemq.ActiveMQConnectionFactory;

import javax.jms.*;

/**
 * @Date: Created in 27/12/2017 2:19 PM
 * @Author: pengganyu
 * @Desc:
 */

public class Cousmer1 {

    public static void main(String[] args) throws JMSException {
        TopicConnectionFactory factory = new ActiveMQConnectionFactory(
            ActiveMQConnectionFactory.DEFAULT_USER, ActiveMQConnectionFactory.DEFAULT_PASSWORD,
            ActiveMQConnectionFactory.DEFAULT_BROKER_URL);

        Connection connection = factory.createTopicConnection();
        connection.setClientID(&quot;consumer1&quot;);
        connection.start();

        Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);

        Topic topic = session.createTopic(&quot;hello&quot;);

        MessageConsumer consumer = session.createDurableSubscriber(topic, &quot;consumer1&quot;);


        //        consumer.setMessageListener(message -&gt; System.out.println(message));

        while (true) {
            TextMessage textMessage = (TextMessage) consumer.receive();
            System.out.println(textMessage.getText());

        }

    }
}

</code></pre>

<pre><code class="language-java">package com.pgy.jms.sub;

import org.apache.activemq.ActiveMQConnectionFactory;

import javax.jms.*;

/**
 * @Date: Created in 27/12/2017 2:19 PM
 * @Author: pengganyu
 * @Desc:
 */

public class Cousmer2 {

    public static void main(String[] args) throws JMSException {
        TopicConnectionFactory factory = new ActiveMQConnectionFactory(
            ActiveMQConnectionFactory.DEFAULT_USER, ActiveMQConnectionFactory.DEFAULT_PASSWORD,
            ActiveMQConnectionFactory.DEFAULT_BROKER_URL);

        Connection connection = factory.createTopicConnection();
        // 与非持久订阅相比，需要设置ClientID
        connection.setClientID(&quot;consumer2&quot;);
        connection.start();

        Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);

        Topic topic = session.createTopic(&quot;hello&quot;);
        // 与非持久订阅相比，需要用持久订阅方法去创建消费者
        MessageConsumer consumer = session.createDurableSubscriber(topic, &quot;consumer2&quot;);

        while (true) {
            TextMessage textMessage = (TextMessage) consumer.receive();

            System.out.println(textMessage.getText());

        }

    }
}

</code></pre>

<h4 id="说明-1">说明</h4>

<ul>
<li>生产者在不停地生产消息，此时若没有人订阅，消息直接废弃（启动Producer）</li>
<li>消费者1启动，无法接收到之前Producer生产的消息，只能接收到当前的消息（启动Consumer1）</li>
<li>消费者2启动，也无法接收之前Producer生产的消息，只能接收到当前的消息（启动Consumer2）</li>
<li>中断消费者2，消费者1继续接收消息，消费者2无法接收消息（停止Consumer2）</li>
<li>启动消费者2，消费者1继续接收消息，消费者2可以接收到之前停止后丢失的消息，并可以继续接收当前消息（启动Consumer2）</li>
<li>ActiveMQ是通过ClientID判断消息是否已经发给连接点，若消费者的ClientID相同，那么只会被某一个消费者接收到消息，而另外一个会报错</li>
<li>与非持久订阅模式的区别仅为设置了ClinetID及创建消费者使用createDurableSubscriber方法</li>
</ul>

</div>


    </div>

    
  </body>
</html>