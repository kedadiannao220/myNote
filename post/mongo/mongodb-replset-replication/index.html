<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.20" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>MongoDB ReplSet Replication &middot; penggy Blog</title>

  
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/print.css" media="print">
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/poole.css">
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/syntax.css">
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="penggy Blog" />
</head>

  <body class=" ">
  <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://kedadiannao220.github.io/"><h1>penggy Blog</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="https://kedadiannao220.github.io/">Home</a> </li>
      <li><a href="/post/"> 首页 </a></li><li><a href="/about/"> 关于 </a></li>
    </ul>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</div>

    <div class="content container">
    <div class="post">
  <h1>MongoDB ReplSet Replication</h1>
  <span class="post-date">Wed, Nov 15, 2017</span>
  

<h2 id="replset-replicatin">ReplSet Replicatin</h2>

<p><img src="http://oxmycii3v.bkt.clouddn.com/img/mongodb/replica-set-trigger-election.bakedsvg.svg" alt="replica-set-trigger-election" /></p>

<p>master的IP： 10.0.1.9     slave IP: 10.0.106.2、10.0.106.6</p>

<p>以replSet形式启动master，replSet名称设置为rs0</p>

<pre><code class="language-shell">mongod --dbpath /home/www/data/ --replSet rs0
</code></pre>

<p>连接master，将自己做为一个member添加进去</p>

<pre><code class="language-shell">&gt; rs.initiate({_id:&quot;rs0&quot;,members:[{_id:0,host:&quot;10.0.1.9:27017&quot;}]})
{
        &quot;info&quot; : &quot;Config now saved locally.  Should come online in about a minute.&quot;,
        &quot;ok&quot; : 1
}
rs0:PRIMARY&gt; 
</code></pre>

<p>初始化成功后，shell会发生改变为   rs0:PRIMARY，标志着replSet的名称和主server；</p>

<p>添加成员</p>

<pre><code class="language-shell">rs0:PRIMARY&gt; rs.add(&quot;10.0.106.2:27017&quot;)
{ &quot;ok&quot; : 1 }
rs0:PRIMARY&gt; rs.add(&quot;10.0.106.6:27017&quot;)
{ &quot;ok&quot; : 1 }
</code></pre>

<p>此时master的日志里面会出现以下log信息，说明已经有成员连接进来</p>

<pre><code class="language-verilog">2017-11-15T10:48:43.995+0800 [rsHealthPoll] replSet member 10.0.106.2:27017 is now in state SECONDARY
</code></pre>

<p>而slave的日志如下，开始连接master，然后并开始同步数据</p>

<pre><code class="language-verilog">2017-11-15T10:48:27.911+0800 I NETWORK  [initandlisten] connection accepted from 10.0.1.9:54292 #1 (1 connection now open)
2017-11-15T10:48:27.913+0800 I NETWORK  [initandlisten] connection accepted from 10.0.1.9:54293 #2 (2 connections now open)
2017-11-15T10:48:27.917+0800 I ASIO     [NetworkInterfaceASIO-Replication-0] Successfully connected to 10.0.1.9:27017
2017-11-15T10:48:27.947+0800 I NETWORK  [conn1] end connection 10.0.1.9:54292 (1 connection now open)
2017-11-15T10:48:27.950+0800 I REPL     [replExecDBWorker-0] Starting replication applier threads
2017-11-15T10:48:27.950+0800 I REPL     [ReplicationExecutor] New replica set config in use: { _id: &quot;rs0&quot;, version: 2, members: [ { _id: 0, host: &quot;10.0.1.9:27017&quot;, arbiterOnly: false, buildIndexes: true, hidden: false, priority: 1.0, ta
gs: {}, slaveDelay: 0, votes: 1 }, { _id: 1, host: &quot;10.0.106.2:27017&quot;, arbiterOnly: false, buildIndexes: true, hidden: false, priority: 1.0, tags: {}, slaveDelay: 0, votes: 1 } ], settings: { chainingAllowed: true, heartbeatIntervalMill
is: 2000, heartbeatTimeoutSecs: 10, electionTimeoutMillis: 10000, getLastErrorModes: {}, getLastErrorDefaults: { w: 1, wtimeout: 0 } } }
2017-11-15T10:48:27.950+0800 I REPL     [ReplicationExecutor] This node is 10.0.106.2:27017 in the config
2017-11-15T10:48:27.950+0800 I REPL     [ReplicationExecutor] transition to STARTUP2
2017-11-15T10:48:27.951+0800 I REPL     [rsSync] ******
2017-11-15T10:48:27.951+0800 I REPL     [rsSync] creating replication oplog of size: 990MB...
2017-11-15T10:48:27.952+0800 I REPL     [ReplicationExecutor] Member 10.0.1.9:27017 is now in state PRIMARY
2017-11-15T10:48:27.956+0800 I STORAGE  [rsSync] Starting WiredTigerRecordStoreThread local.oplog.rs
2017-11-15T10:48:27.957+0800 I STORAGE  [rsSync] The size storer reports that the oplog contains 0 records totaling to 0 bytes
2017-11-15T10:48:27.957+0800 I STORAGE  [rsSync] Scanning the oplog to determine where to place markers for truncation
2017-11-15T10:48:27.996+0800 I REPL     [rsSync] ******
2017-11-15T10:48:27.996+0800 I REPL     [rsSync] initial sync pending
2017-11-15T10:48:28.012+0800 I REPL     [ReplicationExecutor] syncing from: 10.0.1.9:27017
2017-11-15T10:48:28.017+0800 I REPL     [rsSync] initial sync drop all databases
2017-11-15T10:48:28.017+0800 I STORAGE  [rsSync] dropAllDatabasesExceptLocal 1
2017-11-15T10:48:28.017+0800 I REPL     [rsSync] initial sync clone all databases
</code></pre>

<p>mongo shell连接至slave的时候会发现shell变成了如下样式；标志着此server为rs0的replSet，为第二个节点</p>

<pre><code class="language-shell">rs0:SECONDARY&gt; 
</code></pre>

<p>查询配置信息</p>

<pre><code class="language-shell">rs0:SECONDARY&gt; rs.conf();
{        &quot;_id&quot; : &quot;rs0&quot;,
        &quot;version&quot; : 11,
        &quot;members&quot; : [
                {
                        &quot;_id&quot; : 0,
                        &quot;host&quot; : &quot;10.0.1.9:27017&quot;,
                        &quot;arbiterOnly&quot; : false,
                        &quot;buildIndexes&quot; : true,
                        &quot;hidden&quot; : false,
                        &quot;priority&quot; : 2,
                        &quot;tags&quot; : {

                        },
                        &quot;slaveDelay&quot; : NumberLong(0),
                        &quot;votes&quot; : 1
                },
                {
                        &quot;_id&quot; : 1,
                        &quot;host&quot; : &quot;10.0.106.2:27017&quot;,
                        &quot;arbiterOnly&quot; : false,
                        &quot;buildIndexes&quot; : true,
                        &quot;hidden&quot; : false,                        
                        &quot;priority&quot; : 0.8,                       
                        &quot;tags&quot; : {                        
                        },                       
                        &quot;slaveDelay&quot; : NumberLong(0),                        
                        &quot;votes&quot; : 1                
                        },                
                 {
                        &quot;_id&quot; : 2,
                        &quot;host&quot; : &quot;10.0.106.6:27017&quot;,
                        &quot;arbiterOnly&quot; : false,
                        &quot;buildIndexes&quot; : true,
                        &quot;hidden&quot; : false,
                        &quot;priority&quot; : 1,
                        &quot;tags&quot; : {

                        },                        
                        &quot;slaveDelay&quot; : NumberLong(0),                        
                        &quot;votes&quot; : 1                
                  }
        ],
        &quot;settings&quot; : {
                &quot;chainingAllowed&quot; : true,
                &quot;heartbeatIntervalMillis&quot; : 2000,
                &quot;heartbeatTimeoutSecs&quot; : 10,
                &quot;electionTimeoutMillis&quot; : 10000,
                &quot;getLastErrorModes&quot; : {

                },
                &quot;getLastErrorDefaults&quot; : {
                        &quot;w&quot; : 1,
                        &quot;wtimeout&quot; : 0
                }
        }
}
</code></pre>

<p>查看状态</p>

<pre><code class="language-shell">rs0:SECONDARY&gt; rs.status()
{
        &quot;set&quot; : &quot;rs0&quot;,
        &quot;date&quot; : ISODate(&quot;2017-11-15T03:20:32.831Z&quot;),
        &quot;myState&quot; : 2,
        &quot;term&quot; : NumberLong(-1),
        &quot;heartbeatIntervalMillis&quot; : NumberLong(2000),
        &quot;members&quot; : [
                {
                        &quot;_id&quot; : 0,
                        &quot;name&quot; : &quot;10.0.1.9:27017&quot;,
                        &quot;health&quot; : 1,
                        &quot;state&quot; : 1,
                        &quot;stateStr&quot; : &quot;PRIMARY&quot;,
                        &quot;uptime&quot; : 973,
                        &quot;optime&quot; : Timestamp(1510714107, 1),
                        &quot;optimeDate&quot; : ISODate(&quot;2017-11-15T02:48:27Z&quot;),
                        &quot;lastHeartbeat&quot; : ISODate(&quot;2017-11-15T03:20:32.411Z&quot;),
                        &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2017-11-15T03:20:32.129Z&quot;),
                        &quot;pingMs&quot; : NumberLong(0),
                        &quot;electionTime&quot; : Timestamp(1510715061, 1),
                        &quot;electionDate&quot; : ISODate(&quot;2017-11-15T03:04:21Z&quot;),
                        &quot;configVersion&quot; : 2
                },
                {
                        &quot;_id&quot; : 1,
                        &quot;name&quot; : &quot;10.0.106.2:27017&quot;,
                        &quot;health&quot; : 1,
                        &quot;state&quot; : 2,
                        &quot;stateStr&quot; : &quot;SECONDARY&quot;,
                        &quot;uptime&quot; : 974,
                        &quot;optime&quot; : Timestamp(1510714107, 1),
                        &quot;optimeDate&quot; : ISODate(&quot;2017-11-15T02:48:27Z&quot;),
                        &quot;infoMessage&quot; : &quot;could not find member to sync from&quot;,
                        &quot;configVersion&quot; : 2,
                        &quot;self&quot; : true
                }
        ],
        &quot;ok&quot; : 1
}
</code></pre>

<h3 id="遇到的问题">遇到的问题</h3>

<pre><code>&gt; rs.initiate({_id:&quot;xmdb&quot;,members:[{_id:0,host:&quot;10.0.1.9:27017&quot;}]})
{
        &quot;ok&quot; : 0,
        &quot;errmsg&quot; : &quot;local.oplog.rs is not empty on the initiating member.  cannot initiate.&quot;
}
</code></pre>

<p>原因是因为本地已经存在了 replSet的opLog，所以需要去掉，再重新initiate</p>

<pre><code>&gt; use local
switched to db local
&gt; db.dropDatabase()
{ &quot;dropped&quot; : &quot;local&quot;, &quot;ok&quot; : 1 }
</code></pre>

<p>再重新启动，可以考虑换一个新的replSet的名称</p>

<pre><code>mongod --dbpath /home/www/data/ --replSet rs0
</code></pre>

<p>再重新初始化即可</p>

<pre><code>&gt; rs.initiate({_id:&quot;rs0&quot;,members:[{_id:0,host:&quot;10.0.1.9:27017&quot;}]})
{
        &quot;info&quot; : &quot;Config now saved locally.  Should come online in about a minute.&quot;,
        &quot;ok&quot; : 1
}
rs0:PRIMARY&gt; 
</code></pre>

<p>或者直接强制初始化</p>

<pre><code>rs.reconfig(config, {force: true})
</code></pre>

<h3 id="设置权重">设置权重</h3>

<pre><code class="language-shell">rs0:PRIMARY&gt; cfg = rs.conf();
{
        &quot;_id&quot; : &quot;rs0&quot;,
        &quot;version&quot; : 2,
        &quot;members&quot; : [
                {
                        &quot;_id&quot; : 0,
                        &quot;host&quot; : &quot;10.0.1.9:27017&quot;
                &quot;uth_id&quot; : 1,
                        &quot;host&quot; : &quot;10.0.106.2:27017&quot;
                }
        ]
}
rs0:PRIMARY&gt; cfg.members[0].priority=2
2
rs0:PRIMARY&gt; cfg.members[1].priority=1
1
rs0:PRIMARY&gt; cfg.members[2].priority=1
1
rs0:PRIMARY&gt; rs.reconfig(cfg)
</code></pre>

<h4 id="注意事项">注意事项</h4>

<ul>
<li>权重的设置只能在Master当中</li>
</ul>

<pre><code class="language-shell">rs0:SECONDARY&gt; rs.reconfig(cfg)
{
        &quot;ok&quot; : 0,
        &quot;errmsg&quot; : &quot;replSetReconfig command must be sent to the current replica set primary.&quot;
}
</code></pre>

<ul>
<li>三个副本的replSet的名称必须一致</li>
<li>只有两个副本集的时候，PRIMARY挂掉之后，SECONDARY是不会成为PRIMARY的，必须三个副本集以上，最多50个副本集，并且只允许7个可投票进行选举的成员</li>
<li>priority设置为0的成员是不参与投票的</li>
<li>当PRIMARY挂掉的时候，权重高的会被设置为PRIMARY；</li>
<li>非PRIMARY的副本只允许查询，不允许其他的操作；</li>
</ul>

</div>


    </div>

    
  </body>
</html>