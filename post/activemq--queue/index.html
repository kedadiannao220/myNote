<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.20" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>ActiveMQ Queue Model &middot; penggy Blog</title>

  
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/print.css" media="print">
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/poole.css">
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/syntax.css">
  <link rel="stylesheet" href="https://kedadiannao220.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="penggy Blog" />
</head>

  <body class=" ">
  <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://kedadiannao220.github.io/"><h1>penggy Blog</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="https://kedadiannao220.github.io/">Home</a> </li>
      <li><a href="/post/"> 首页 </a></li><li><a href="/about/"> 关于 </a></li>
    </ul>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</div>

    <div class="content container">
    <div class="post">
  <h1>ActiveMQ Queue Model</h1>
  <span class="post-date">Tue, Aug 1, 2017</span>
  

<h1 id="activemq是干什么的">ActiveMQ是干什么的？</h1>

<ul>
<li><a href="http://activemq.apache.org/">Apache ActiveMQ</a>
是一个开源的消息集成服务</li>
<li>支持多语言，支持<a href="http://www.oracle.com/technetwork/java/jms/index.html">JMS1.1</a>
J2EE1.4</li>
<li>首先需要了解什么是JMS和JMS相关的API：<a href="http://docs.oracle.com/javaee/6/tutorial/doc/bncdq.html">Java Message Service
Concepts</a></li>
</ul>

<h1 id="queue模式">Queue模式</h1>

<h2 id="简单demo">简单demo</h2>

<h3 id="下载activemq-并运行-activemq-getting-started-http-activemq-apache-org-version-5-getting-started-html">下载ActiveMQ，并运行 <a href="http://activemq.apache.org/version-5-getting-started.html">ActiveMQ Getting Started</a></h3>

<h3 id="说明-activemq-all的jar包需要使用jdk1-8">说明 activemq-all的jar包需要使用jdk1.8</h3>

<h3 id="pom-xml">pom.xml</h3>

<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;
    &lt;artifactId&gt;activemq-all&lt;/artifactId&gt;
    &lt;version&gt;5.15.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<pre><code class="language-java">package com.pgy.jms.p2p;

import org.apache.activemq.ActiveMQConnectionFactory;

import javax.jms.*;

/**
 * @Date: Created in 27/12/2017 2:19 PM
 * @Author: pengganyu
 * @Desc:
 */

public class Cousmer {

    public static void main(String[] args) throws JMSException {
        ConnectionFactory factory = new ActiveMQConnectionFactory(
            ActiveMQConnectionFactory.DEFAULT_USER, ActiveMQConnectionFactory.DEFAULT_PASSWORD,
            ActiveMQConnectionFactory.DEFAULT_BROKER_URL);

        Connection connection = factory.createConnection();
        connection.start();//若connection不启动，不会进行连接消费

        Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);

        Queue queue = session.createQueue(&quot;hello&quot;);

        MessageConsumer consumer = session.createConsumer(queue);

        //        consumer.setMessageListener(message -&gt; System.out.println(message));

        while (true) {
            TextMessage textMessage = (TextMessage) consumer.receive();

            System.out.println(textMessage);

        }

    }
}

</code></pre>

<pre><code class="language-java">package com.pgy.jms.p2p;

import org.apache.activemq.ActiveMQConnectionFactory;

import javax.jms.*;

/**
 * @Date: Created in 27/12/2017 1:01 PM
 * @Author: pengganyu
 * @Desc:
 */

public class Producer {

    public static void main(String[] args) throws JMSException {
        ConnectionFactory factory = new ActiveMQConnectionFactory(
            ActiveMQConnectionFactory.DEFAULT_USER, ActiveMQConnectionFactory.DEFAULT_PASSWORD,
            ActiveMQConnectionFactory.DEFAULT_BROKER_URL);

        Connection connection = factory.createConnection();

        Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);

        Queue queue = session.createQueue(&quot;hello&quot;);

        MessageProducer producer = session.createProducer(queue);

        for (int i = 0; i &lt; 100; i++) {
            TextMessage tx = session.createTextMessage(&quot;hello&quot; + i);
            producer.send(tx);
        }

        connection.close();

    }
}

</code></pre>

<h3 id="说明">说明</h3>

<ul>
<li>当生产者生产消息时，没有consumer连接时，消息直接废弃</li>
<li>consumer类当中，若Connection若未start，则不会得到消息</li>
<li>当生产者生产消息时，若有n个consumer连接时，消息被平均分配到每一个consumer里面，即每个consumer接收到 sum(message)/n</li>
</ul>

<h2 id="另一个demo">另一个demo</h2>

<h3 id="消费者">消费者</h3>

<pre><code class="language-java">package com.pgy.mq;

import org.apache.activemq.ActiveMQConnection;
import org.apache.activemq.ActiveMQConnectionFactory;

import javax.jms.*;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * Created by admin on 25/07/2017.
 */
public class Consumer {
    private static String        USER_NAME   = ActiveMQConnection.DEFAULT_USER;

    private static String        PASSWORD    = ActiveMQConnection.DEFAULT_PASSWORD;

    private static String        BROKEN_URL  = ActiveMQConnection.DEFAULT_BROKER_URL;

    AtomicInteger                count       = new AtomicInteger(0);

    ActiveMQConnectionFactory    connectionFactory;

    Connection                   connection;

    Session                      session;

    ThreadLocal&lt;MessageConsumer&gt; threadLocal = new ThreadLocal();

    public void init() {
        try {
            connectionFactory = new ActiveMQConnectionFactory(USER_NAME, PASSWORD, BROKEN_URL);
            connection = connectionFactory.createConnection();
            connection.start();
            session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
        } catch (JMSException e) {
            e.printStackTrace();
        }
    }

    public void getMessage(String disName) {
        Queue queue = null;
        try {
            queue = session.createQueue(disName);
            MessageConsumer messageConsumer = null;

            if (threadLocal.get() != null) {
                messageConsumer = threadLocal.get();
            } else {
                messageConsumer = session.createConsumer(queue);

                threadLocal.set(messageConsumer);
            }

            while (true) {
                Thread.sleep(1000);

                TextMessage textMessage = (TextMessage) messageConsumer.receive();

                if (textMessage != null) {
                    textMessage.acknowledge();

                    System.out.println(Thread.currentThread().getName() + &quot;获取消息:&quot;
                                       + textMessage.getText() + &quot;-----&quot; + count.getAndIncrement());
                } else {
                    break;
                }

            }
        } catch (JMSException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

    }

}

</code></pre>

<h3 id="生产者">生产者</h3>

<pre><code class="language-java">package com.pgy.mq;

import org.apache.activemq.ActiveMQConnection;
import org.apache.activemq.ActiveMQConnectionFactory;

import javax.jms.*;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * Created by admin on 25/07/2017.
 */
public class Producter {

    private static String            USER_NAME   = ActiveMQConnection.DEFAULT_USER;

    private static String            PASSWORD    = ActiveMQConnection.DEFAULT_PASSWORD;

    private static String            BROKEN_URL  = ActiveMQConnection.DEFAULT_BROKER_URL;

    static AtomicInteger             count       = new AtomicInteger(0);

    static ActiveMQConnectionFactory connectionFactory;

    static Connection                connection;

    static Session                   session;

    static ThreadLocal&lt;MessageProducer&gt;     threadLocal = new ThreadLocal();

    public static void main(String[] args) {
        init();
        sendMessage(&quot;hello&quot;);
    }

    public static void init() {

        try {
            connectionFactory = new ActiveMQConnectionFactory(USER_NAME, PASSWORD, BROKEN_URL);
            connection = connectionFactory.createConnection();

            connection.start();

            session = connection.createSession(true, Session.SESSION_TRANSACTED);
        } catch (JMSException e) {
            e.printStackTrace();
        }

    }

    public static void sendMessage(String disName) {
        try {
            Queue queue = session.createQueue(disName);

            MessageProducer messageProducer = null;

            if (threadLocal.get() != null) {
                messageProducer = threadLocal.get();
            } else {
                messageProducer = session.createProducer(queue);

                threadLocal.set(messageProducer);
            }

            while (true) {
                Thread.sleep(10000);

                int sum = count.getAndIncrement();

                TextMessage textMessage = session.createTextMessage(
                    Thread.currentThread().getName() + &quot;helloWorld, times = &quot; + sum);

                messageProducer.send(textMessage);

                session.commit();
            }

        } catch (JMSException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

    }

}

</code></pre>

<h3 id="生产消息">生产消息</h3>

<pre><code class="language-java">package com.pgy.mq;

/**
 * Created by admin on 25/07/2017.
 */
public class TestMProducter {

    public static void main(String[] args) {

        Producter producter = new Producter();
        producter.init();

        TestMProducter testMProducter = new TestMProducter();

        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        new Thread(testMProducter.new ProducterMq(producter)).start();
        new Thread(testMProducter.new ProducterMq(producter)).start();
        new Thread(testMProducter.new ProducterMq(producter)).start();
        new Thread(testMProducter.new ProducterMq(producter)).start();
        new Thread(testMProducter.new ProducterMq(producter)).start();

    }

    private class ProducterMq implements Runnable {
        Producter producter;

        public ProducterMq(Producter producter) {
            this.producter = producter;
        }

        @Override
        public void run() {
            while (true) {
                producter.sendMessage(&quot;pengganyu&quot;);
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}

</code></pre>

<h3 id="消费消息">消费消息</h3>

<pre><code class="language-java">package com.pgy.mq;

/**
 * Created by admin on 01/08/2017.
 */
public class TestConsumer {

    public static void main(String[] args) {

        Consumer consumer = new Consumer();
        consumer.init();

        TestConsumer testMProducter = new TestConsumer();

        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        new Thread(testMProducter.new ConsumerMq(consumer)).start();
        new Thread(testMProducter.new ConsumerMq(consumer)).start();
        new Thread(testMProducter.new ConsumerMq(consumer)).start();
        new Thread(testMProducter.new ConsumerMq(consumer)).start();
        new Thread(testMProducter.new ConsumerMq(consumer)).start();

    }

    private class ConsumerMq implements Runnable {
        Consumer consumer;

        public ConsumerMq(Consumer cosum) {
            this.consumer = cosum;
        }

        @Override
        public void run() {
            while (true) {
                consumer.getMessage(&quot;pengganyu&quot;);
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}


</code></pre>

<h3 id="监控台">监控台</h3>

<ul>
<li>127.0.0.1:8161/admin</li>
<li>跑一会生产消息后，控制台的QUEU里面会有消息的数量在增加</li>
<li>关掉生产消息进程，此时的消息会被存放，等消费消息的代码跑起来后，消息数量才会减少（跑到这里，我激动了一把，这玩意太牛叉了，我以后要好好研究这玩意是怎么实现的）</li>
</ul>

<h1 id="一些资源">一些资源</h1>

<ul>
<li><a href="http://activemq.apache.org/version-5-getting-started.html">ActiveMQ技术详解专栏</a></li>
</ul>

</div>


    </div>

    
  </body>
</html>