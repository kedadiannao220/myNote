---

date :  "2021-01-26T14:06:50+08:00" 
title : "istio 1.8—环境搭建" 
categories : ["istio"] 
tags : ["istio"] 
toc : true
description: istio 1.8 环境搭建
---

## Istio 1.8—环境搭建

Istio是一个服务治理的开放平台，1.8与前版本的命令不太一样；官网给了一个安装流程[Getting Started](https://istio.io/latest/docs/setup/getting-started/)，

### 安装过程

#### 下载istio 1.8版本

```shell
istio-1.8.1/
├── bin
├── LICENSE
├── manifests
├── README.md
├── samples
└── tools
```

#### 设置`istioctl`

```shell
cp bin/istioctl /usr/local/bin/
cp tools/istioctl.bash ~/.istioctl.bash
source ~/.istioctl.bash
```

#### 安装`profile`

可以看到内置的profile，几个profile的区别[config-profiles](https://istio.io/latest/docs/setup/additional-setup/config-profiles/)；安装demo的profile，因为可以有一个`bookinfo`的应用来做为实验，

```shell
# istioctl profile list
Istio configuration profiles:
    default
    demo
    empty
    minimal
    openshift
    preview
    remote
```

```shell
# istioctl install --set profile=demo
This will install the Istio demo profile with ["Istio core" "Istiod" "Ingress gateways" "Egress gateways"] components into the cluster. Proceed? (y/N) y
Detected that your cluster does not support third party JWT authentication. Falling back to less secure first party JWT. See https://istio.io/v1.8/docs/ops/best-practices/security/#configure-third-party-service-account-tokens for details.
✔ Istio core installed
✔ Istiod installed
✔ Egress gateways installed
✔ Ingress gateways installed
✔ Installation complete
```

### 其他配置

配置`istio`允许注入`envoy`的`sidecar`代理 

```shell
kubectl label namespace default istio-injection=enabled
```

### 部署示例bookinfo

```shell
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
kubectl apply -f samples/addons
```

查看`bookInfo`访问地址：http://10.0.4.144:32351/productpage

```shell
# echo $(kubectl get po -l istio=ingressgateway -n istio-system -o jsonpath='{.items[0].status.hostIP}'):$( kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].nodePort}')/productpage
10.0.4.144:32351/productpage
```

配置`kiali`后台访问地址：http://10.0.4.175:20001/

```shell
istioctl dashboard kiali --address 10.0.4.175 -p 20001
```

